{% extends "spf_referral_vulnerability_check/base.html" %}
<html lang="en">
<head>
    <title>Result</title>
</head>
<body>
{% block pagecontent %}
    <div class="row col-lg-12">
        <div class="card" id="meta_info" hidden>
            <div class="card-body">
                <div class="card-title">Meta Info
                </div>
                <div class="card-text">
                    Your server made <b id="lookups">{{ lookups }}</b> lookups.
                    <br>
                    We measured the following MX server for your email address (<b id="to_address">{{ to_address }}</b>): at
                    <b id="sent_on">{{ sent_on }}</b> UTC.
                </div>
            </div>
        </div>
    </div>

    <div class="row col-lg-12">
        <div class="card" id="dns_queries" hidden>
            <div class="card-body">
                <div class="card-title">DNS Queries</div>
                <div class="card-text">
                    Here are the DNS TXT queries we received in response to the email from your server's
                    associated recursive resolver <i>till now</i>.
                    <br>
                    <b>Date-Time, Resolver IP, Query Name, Query Type, Protocol</b>
                    <pre id="queries">{{ queries }}</pre>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-body" id="results">
                <div class="card-title">Results</div>
                <div class="card-text">
                    <strong id="wait">Please wait while we fetch your results.</strong>
                    <div class="spinner-grow float-right ml-auto" role="status" aria-hidden="true" id="loading"></div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
</body>
{% block script %}
    <script>
        $(document).ready(function () {
            let rand_id = '{{ rand_id }}';
            if (rand_id === 'None') {
                alert("Please paste correct link");
            } else {
                setTimeout(get_search_data, 12000, rand_id);
            }
        });

        function get_search_data(rand_id) {
            if (rand_id) {
                $.ajax({
                    url: "_search?uuid=" + rand_id,
                    timeout: 20000,
                    type: "GET",
                    // data: JSON.stringify(data),
                    contentType: "application/json",
                    /*
                    beforeSend: function (xhr, settings) {
                        xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
                    },
                    */
                    dataType: 'json',
                    success: function (result) {
                        if (result.lookups) {
                            $('#lookups').text(result.lookups);
                            $('#sent_on').text(result.sent_on);
                            $('#to_address').text(result.to_address);
                            $('#queries').text(result.queries);
                            $('#loading').attr("hidden", true);
                            $('#meta_info').attr("hidden", false);
                            $('#dns_queries').attr("hidden", false);
                            $('#results').attr("hidden", true);
                        } else {
                            $('#wait').text("Sorry, your result is not available yet. Did you forget to send us an email?")
                            $('#loading').attr("hidden", true);
                            $('#meta_info').attr("hidden", true);
                            $('#dns_queries').attr("hidden", true);
                            $('#results').attr("hidden", false);
                        }
                    },
                    failure: function (result) {
                        $('#wait').text("Sorry, your result is not available yet. Please try again later.")
                        $('#loading').attr("hidden", true);
                        $('#meta_info').attr("hidden", true);
                        $('#dns_queries').attr("hidden", true);
                        $('#results').attr("hidden", false);
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        if(textStatus==="timeout") {
                            $('#wait').text("Sorry, your result is not available yet. Please try again later.")
                            $('#loading').attr("hidden", true);
                            $('#meta_info').attr("hidden", true);
                            $('#dns_queries').attr("hidden", true);
                            $('#results').attr("hidden", false);
                        }
                    }
                });
            }
        }
    </script>

{% endblock %}
</html>
